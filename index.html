<!-- index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>AI Stock Alert Bot</title>
<style>
  body { font-family: Arial, sans-serif; background:#0d1117; color:#fff; margin:20px; text-align:center;}
  h1 { color:#00ffcc; }
  .container { max-width:1000px; margin:0 auto; text-align:left; }
  table { width:100%; border-collapse:collapse; margin-bottom:20px; }
  th, td { padding:8px 10px; border-bottom:1px solid #222; }
  th { text-align:left; background:#0f1720; color:#9ad; }
  tr.up { background: rgba(0,255,0,0.05); }
  tr.down { background: rgba(255,0,0,0.05); }
  .btn { display:inline-block; padding:10px 14px; background:#0ea5a3; color:#042; border-radius:6px; text-decoration:none; margin-right:8px;}
  .alert { padding:6px 10px; display:inline-block; border-radius:6px; margin-right:8px; background:#222; color:#fff; }
  .small { font-size:12px; color:#bbb; }
</style>
</head>
<body>
  <div class="container">
    <h1>ü§ñ AI Stock Alert Bot</h1>
    <p class="small">Auto-scan every 5 minutes. Manual scan: click button. Alerts stored in SQLite.</p>

    <div style="margin-bottom:12px;">
      <a class="btn" href="#" id="manualScan">üîÅ Manual Scan</a>
      <a class="btn" href="#" id="refresh">üîÑ Refresh</a>
      <span class="alert">Auto-scan interval: 5 min</span>
    </div>

    <h2>Live Stocks (snapshot)</h2>
    <table id="stocksTable">
      <thead><tr><th>Symbol</th><th>Change (%)</th><th>Price</th><th>Volume</th><th>AI Prediction</th></tr></thead>
      <tbody></tbody>
    </table>

    <h2>Saved Alerts (history)</h2>
    <table id="alertsTable">
      <thead><tr><th>Time (UTC)</th><th>Symbol</th><th>Price</th><th>Change%</th><th>AI</th><th>Type</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

<script>
async function fetchStocks(){
  try{
    const res = await fetch('/api/stocks');
    const data = await res.json();
    const tbody = document.querySelector('#stocksTable tbody');
    tbody.innerHTML = '';
    data.forEach(s=>{
      const tr = document.createElement('tr');
      tr.className = s.change_pct >= 0 ? 'up' : 'down';
      tr.innerHTML = `<td>${s.symbol}</td><td>${s.change_pct}</td><td>${s.price.toFixed(2)}</td><td>${(s.volume||0).toLocaleString()}</td><td>${s.ai_prediction||''}</td>`;
      tbody.appendChild(tr);
    });
  }catch(e){
    console.error(e);
  }
}

async function fetchAlerts(){
  try{
    const res = await fetch('/api/alerts?limit=200');
    const data = await res.json();
    const tbody = document.querySelector('#alertsTable tbody');
    tbody.innerHTML = '';
    data.forEach(a=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${a.created_at}</td><td>${a.symbol}</td><td>${(a.price||0).toFixed(2)}</td><td>${a.change_pct}</td><td>${a.ai_prediction}</td><td>${a.alert_type}</td>`;
      tbody.appendChild(tr);
    });
  }catch(e){
    console.error(e);
  }
}

document.getElementById('manualScan').addEventListener('click', async (e)=>{
  e.preventDefault();
  document.getElementById('manualScan').innerText = 'Started...';
  await fetch('/trigger-scan', {method:'POST'}).catch(()=>{});
  setTimeout(()=>{ document.getElementById('manualScan').innerText = 'üîÅ Manual Scan'; refreshAll(); }, 2000);
});

document.getElementById('refresh').addEventListener('click', (e)=>{ e.preventDefault(); refreshAll(); });

function refreshAll(){ fetchStocks(); fetchAlerts(); }

refreshAll();
setInterval(fetchStocks, 300000); // 5 min
setInterval(fetchAlerts, 300000);
</script>
</body>
</html>
